#!/bin/bash

#exit on error
set -e

ARCH_DIR="$(pwd)"

source "$ARCH_DIR"/first_run

sudo pacman -Syu --noconfirm

sudo pacman -S base-devel gum --noconfirm --needed

if ! command -v paru &> /dev/null; then
    echo "Installing paru AUR helper..."

    [[ -d "paru" ]] && rm -rf paru
    git clone https://aur.archlinux.org/paru.git
    cd paru
    makepkg -si --noconfirm
    cd ..
    rm -rf paru
else
    echo "paru is already installed"
fi

for script in "$ARCH_DIR"/scripts/*; do
    [[ -f "$script" ]] || continue
    echo "Running $script..."
    source "$script"
done

echo "Temporarily disabling mkinitcpio hooks during installation..."

# Move the specific mkinitcpio pacman hooks out of the way if they exist
if [ -f /usr/share/libalpm/hooks/90-mkinitcpio-install.hook ]; then
  sudo mv /usr/share/libalpm/hooks/90-mkinitcpio-install.hook /usr/share/libalpm/hooks/90-mkinitcpio-install.hook.disabled
fi

if [ -f /usr/share/libalpm/hooks/60-mkinitcpio-remove.hook ]; then
  sudo mv /usr/share/libalpm/hooks/60-mkinitcpio-remove.hook /usr/share/libalpm/hooks/60-mkinitcpio-remove.hook.disabled
fi

echo "mkinitcpio hooks disabled"


mapfile -t packages < <(grep -v '^#' "$ARCH_DIR"/base.packages)
paru -Syu --noconfirm --needed "${packages[@]}"

for install in "$ARCH_DIR"/install/*; do
    [[ -f "$install" ]] || continue
    echo "Running $install..."
    source "$install"
done

for post in "$ARCH_DIR"/post/*; do
    [[ -f "$post" ]] || continue
    source "$post"
done

# Finish
choice=$(gum choose --limit 1 --height 4 --header "Setup complete. Reboot now?" "Yes" "No")

# Trim whitespace just in case
choice=$(echo "$choice" | tr -d '\n' | tr -d '\r')

if [ "$choice" = "Yes" ]; then
    echo "Rebooting..."
    sudo shutdown -r now
else
    echo "Okay, continue with whatever you want."
fi

